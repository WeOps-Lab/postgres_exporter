apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: create-pg-account-old
  namespace: postgres
spec:
  schedule: "*/5 * * * *"
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      activeDeadlineSeconds: 300
      template:
        spec:
          nodeSelector:
            node-role: worker
          containers:
          - name: create-pg-standalone-v9-4-account
            image: bitnami/postgresql:9.4.6
            command:
              - /bin/sh
              - -c
              - |
                  PGPASSWORD=Weops123! psql -h pg-standalone-v9-4-postgresql -U postgres -c "
                    CREATE OR REPLACE FUNCTION __tmp_create_user() returns void as \$\$
                    BEGIN
                      IF NOT EXISTS (
                              SELECT                       -- SELECT list can stay empty for this
                              FROM   pg_catalog.pg_user
                              WHERE  usename = 'weops') THEN
                        CREATE USER weops;
                      END IF;
                    END;
                    \$\$ language plpgsql;

                    SELECT __tmp_create_user();
                    DROP FUNCTION __tmp_create_user();

                    ALTER USER weops WITH PASSWORD 'Weops123!';
                    ALTER USER weops SET SEARCH_PATH TO weops,pg_catalog;

                    GRANT CONNECT ON DATABASE postgres TO weops;
                    CREATE SCHEMA IF NOT EXISTS weops;
                    GRANT USAGE ON SCHEMA weops TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_activity() RETURNS SETOF pg_stat_activity AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_activity; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_activity
                    AS
                      SELECT * from get_pg_stat_activity();

                    GRANT SELECT ON weops.pg_stat_activity TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_replication() RETURNS SETOF pg_stat_replication AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_replication; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_replication
                    AS
                      SELECT * FROM get_pg_stat_replication();

                    GRANT SELECT ON weops.pg_stat_replication TO weops;

                    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
                    CREATE OR REPLACE FUNCTION get_pg_stat_statements() RETURNS SETOF pg_stat_statements AS
                    \$\$ SELECT * FROM public.pg_stat_statements; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_statements
                    AS
                      SELECT * FROM get_pg_stat_statements();

                    GRANT SELECT ON weops.pg_stat_statements TO weops;"

          - name: create-pg-standalone-v9-5-account
            image: bitnami/postgresql:9.5.2-0
            command:
              - /bin/sh
              - -c
              - |
                  PGPASSWORD=Weops123! psql -h pg-standalone-v9-5-postgresql -U postgres -c "
                    CREATE OR REPLACE FUNCTION __tmp_create_user() returns void as \$\$
                    BEGIN
                      IF NOT EXISTS (
                              SELECT                       -- SELECT list can stay empty for this
                              FROM   pg_catalog.pg_user
                              WHERE  usename = 'weops') THEN
                        CREATE USER weops;
                      END IF;
                    END;
                    \$\$ language plpgsql;

                    SELECT __tmp_create_user();
                    DROP FUNCTION __tmp_create_user();

                    ALTER USER weops WITH PASSWORD 'Weops123!';
                    ALTER USER weops SET SEARCH_PATH TO weops,pg_catalog;

                    GRANT CONNECT ON DATABASE postgres TO weops;

                    CREATE SCHEMA IF NOT EXISTS weops;
                    GRANT USAGE ON SCHEMA weops TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_activity() RETURNS SETOF pg_stat_activity AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_activity; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_activity
                    AS
                      SELECT * from get_pg_stat_activity();

                    GRANT SELECT ON weops.pg_stat_activity TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_replication() RETURNS SETOF pg_stat_replication AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_replication; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_replication
                    AS
                      SELECT * FROM get_pg_stat_replication();

                    GRANT SELECT ON weops.pg_stat_replication TO weops;

                    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
                    CREATE OR REPLACE FUNCTION get_pg_stat_statements() RETURNS SETOF pg_stat_statements AS
                    \$\$ SELECT * FROM public.pg_stat_statements; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_statements
                    AS
                      SELECT * FROM get_pg_stat_statements();

                    GRANT SELECT ON weops.pg_stat_statements TO weops;"

          - name: create-pg-cluster-primary-v9-4-account
            image: bitnami/postgresql:9.4.6
            command:
              - /bin/sh
              - -c
              - |
                  PGPASSWORD=Weops123! psql -h pg-cluster-v9-4-postgresql-primary -U postgres -c "
                    CREATE OR REPLACE FUNCTION __tmp_create_user() returns void as \$\$
                    BEGIN
                      IF NOT EXISTS (
                              SELECT                       -- SELECT list can stay empty for this
                              FROM   pg_catalog.pg_user
                              WHERE  usename = 'weops') THEN
                        CREATE USER weops;
                      END IF;
                    END;
                    \$\$ language plpgsql;

                    SELECT __tmp_create_user();
                    DROP FUNCTION __tmp_create_user();

                    ALTER USER weops WITH PASSWORD 'Weops123!';
                    ALTER USER weops SET SEARCH_PATH TO weops,pg_catalog;

                    GRANT CONNECT ON DATABASE postgres TO weops;

                    CREATE SCHEMA IF NOT EXISTS weops;
                    GRANT USAGE ON SCHEMA weops TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_activity() RETURNS SETOF pg_stat_activity AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_activity; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_activity
                    AS
                      SELECT * from get_pg_stat_activity();

                    GRANT SELECT ON weops.pg_stat_activity TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_replication() RETURNS SETOF pg_stat_replication AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_replication; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_replication
                    AS
                      SELECT * FROM get_pg_stat_replication();

                    GRANT SELECT ON weops.pg_stat_replication TO weops;

                    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
                    CREATE OR REPLACE FUNCTION get_pg_stat_statements() RETURNS SETOF pg_stat_statements AS
                    \$\$ SELECT * FROM public.pg_stat_statements; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_statements
                    AS
                      SELECT * FROM get_pg_stat_statements();

                    GRANT SELECT ON weops.pg_stat_statements TO weops;"

          - name: create-pg-cluster-primary-v9-5-account
            image: bitnami/postgresql:9.5.2-0
            command:
              - /bin/sh
              - -c
              - |
                  PGPASSWORD=Weops123! psql -h pg-cluster-v9-5-postgresql-primary -U postgres -c "
                    CREATE OR REPLACE FUNCTION __tmp_create_user() returns void as \$\$
                    BEGIN
                      IF NOT EXISTS (
                              SELECT                       -- SELECT list can stay empty for this
                              FROM   pg_catalog.pg_user
                              WHERE  usename = 'weops') THEN
                        CREATE USER weops;
                      END IF;
                    END;
                    \$\$ language plpgsql;

                    SELECT __tmp_create_user();
                    DROP FUNCTION __tmp_create_user();

                    ALTER USER weops WITH PASSWORD 'Weops123!';
                    ALTER USER weops SET SEARCH_PATH TO weops,pg_catalog;

                    GRANT CONNECT ON DATABASE postgres TO weops;

                    CREATE SCHEMA IF NOT EXISTS weops;
                    GRANT USAGE ON SCHEMA weops TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_activity() RETURNS SETOF pg_stat_activity AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_activity; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_activity
                    AS
                      SELECT * from get_pg_stat_activity();

                    GRANT SELECT ON weops.pg_stat_activity TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_replication() RETURNS SETOF pg_stat_replication AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_replication; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_replication
                    AS
                      SELECT * FROM get_pg_stat_replication();

                    GRANT SELECT ON weops.pg_stat_replication TO weops;

                    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
                    CREATE OR REPLACE FUNCTION get_pg_stat_statements() RETURNS SETOF pg_stat_statements AS
                    \$\$ SELECT * FROM public.pg_stat_statements; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_statements
                    AS
                      SELECT * FROM get_pg_stat_statements();

                    GRANT SELECT ON weops.pg_stat_statements TO weops;"

          - name: create-pg-cluster-secondary-v9-4-account
            image: bitnami/postgresql:9.4.6
            command:
              - /bin/sh
              - -c
              - |
                  PGPASSWORD=Weops123! psql -h pg-cluster-v9-4-postgresql-secondary -U postgres -c "
                    CREATE OR REPLACE FUNCTION __tmp_create_user() returns void as \$\$
                    BEGIN
                      IF NOT EXISTS (
                              SELECT                       -- SELECT list can stay empty for this
                              FROM   pg_catalog.pg_user
                              WHERE  usename = 'weops') THEN
                        CREATE USER weops;
                      END IF;
                    END;
                    \$\$ language plpgsql;

                    SELECT __tmp_create_user();
                    DROP FUNCTION __tmp_create_user();

                    ALTER USER weops WITH PASSWORD 'Weops123!';
                    ALTER USER weops SET SEARCH_PATH TO weops,pg_catalog;

                    GRANT CONNECT ON DATABASE postgres TO weops;

                    CREATE SCHEMA IF NOT EXISTS weops;
                    GRANT USAGE ON SCHEMA weops TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_activity() RETURNS SETOF pg_stat_activity AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_activity; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_activity
                    AS
                      SELECT * from get_pg_stat_activity();

                    GRANT SELECT ON weops.pg_stat_activity TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_replication() RETURNS SETOF pg_stat_replication AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_replication; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_replication
                    AS
                      SELECT * FROM get_pg_stat_replication();

                    GRANT SELECT ON weops.pg_stat_replication TO weops;

                    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
                    CREATE OR REPLACE FUNCTION get_pg_stat_statements() RETURNS SETOF pg_stat_statements AS
                    \$\$ SELECT * FROM public.pg_stat_statements; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_statements
                    AS
                      SELECT * FROM get_pg_stat_statements();

                    GRANT SELECT ON weops.pg_stat_statements TO weops;"


          - name: create-pg-cluster-secondary-v9-5-account
            image: bitnami/postgresql:9.5.2-0
            command:
              - /bin/sh
              - -c
              - |
                  PGPASSWORD=Weops123! psql -h pg-cluster-v9-5-postgresql-secondary -U postgres -c "
                    CREATE OR REPLACE FUNCTION __tmp_create_user() returns void as \$\$
                    BEGIN
                      IF NOT EXISTS (
                              SELECT                       -- SELECT list can stay empty for this
                              FROM   pg_catalog.pg_user
                              WHERE  usename = 'weops') THEN
                        CREATE USER weops;
                      END IF;
                    END;
                    \$\$ language plpgsql;

                    SELECT __tmp_create_user();
                    DROP FUNCTION __tmp_create_user();

                    ALTER USER weops WITH PASSWORD 'Weops123!';
                    ALTER USER weops SET SEARCH_PATH TO weops,pg_catalog;

                    GRANT CONNECT ON DATABASE postgres TO weops;

                    CREATE SCHEMA IF NOT EXISTS weops;
                    GRANT USAGE ON SCHEMA weops TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_activity() RETURNS SETOF pg_stat_activity AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_activity; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_activity
                    AS
                      SELECT * from get_pg_stat_activity();

                    GRANT SELECT ON weops.pg_stat_activity TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_replication() RETURNS SETOF pg_stat_replication AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_replication; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_replication
                    AS
                      SELECT * FROM get_pg_stat_replication();

                    GRANT SELECT ON weops.pg_stat_replication TO weops;

                    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
                    CREATE OR REPLACE FUNCTION get_pg_stat_statements() RETURNS SETOF pg_stat_statements AS
                    \$\$ SELECT * FROM public.pg_stat_statements; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_statements
                    AS
                      SELECT * FROM get_pg_stat_statements();

                    GRANT SELECT ON weops.pg_stat_statements TO weops;"

          - name: create-pg-cluster-secondary-v11-account
            image: bitnami/postgresql:11.0.0
            command:
              - /bin/sh
              - -c
              - |
                  PGPASSWORD=Weops123! psql -h pg-cluster-v11-0-postgresql-secondary -U postgres -c "
                    CREATE OR REPLACE FUNCTION __tmp_create_user() returns void as \$\$
                    BEGIN
                      IF NOT EXISTS (
                              SELECT                       -- SELECT list can stay empty for this
                              FROM   pg_catalog.pg_user
                              WHERE  usename = 'weops') THEN
                        CREATE USER weops;
                      END IF;
                    END;
                    \$\$ language plpgsql;

                    SELECT __tmp_create_user();
                    DROP FUNCTION __tmp_create_user();

                    ALTER USER weops WITH PASSWORD 'Weops123!';
                    ALTER USER weops SET SEARCH_PATH TO weops,pg_catalog;

                    GRANT CONNECT ON DATABASE postgres TO weops;

                    CREATE SCHEMA IF NOT EXISTS weops;
                    GRANT USAGE ON SCHEMA weops TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_activity() RETURNS SETOF pg_stat_activity AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_activity; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_activity
                    AS
                      SELECT * from get_pg_stat_activity();

                    GRANT SELECT ON weops.pg_stat_activity TO weops;

                    CREATE OR REPLACE FUNCTION get_pg_stat_replication() RETURNS SETOF pg_stat_replication AS
                    \$\$ SELECT * FROM pg_catalog.pg_stat_replication; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_replication
                    AS
                      SELECT * FROM get_pg_stat_replication();

                    GRANT SELECT ON weops.pg_stat_replication TO weops;

                    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
                    CREATE OR REPLACE FUNCTION get_pg_stat_statements() RETURNS SETOF pg_stat_statements AS
                    \$\$ SELECT * FROM public.pg_stat_statements; \$\$
                    LANGUAGE sql
                    VOLATILE
                    SECURITY DEFINER;

                    CREATE OR REPLACE VIEW weops.pg_stat_statements
                    AS
                      SELECT * FROM get_pg_stat_statements();

                    GRANT SELECT ON weops.pg_stat_statements TO weops;"

          restartPolicy: Never